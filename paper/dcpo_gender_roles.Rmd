---
output: 
  pdf_document:
    citation_package: natbib
    keep_tex: true
    fig_caption: true
    latex_engine: pdflatex
    template: svm-latex-ms2.tex
title: "Public Gender Egalitarianism: A Dataset of Dynamic Comparative Public Opinion Toward Egalitarian Gender Roles in the Public Sphere"
thanks: "Corresponding author: [frederick-solt@uiowa.edu](mailto:frederick-solt@uiowa.edu).  Current version: `r format(Sys.time(), '%B %d, %Y')`."
author:

abstract: ""
keywords: "gender inequality, public opinion, measurement"
date: "`r format(Sys.time(), '%B %d, %Y')`"
fontsize: 11pt
spacing: double
bibliography: \dummy{`r file.path(getwd(), list.files(getwd(), "s.bib$", recursive = TRUE))`}
# csl: https://raw.githubusercontent.com/citation-style-language/styles/master/american-political-science-association.csl
biblio-style: apsr
citecolor: black
linkcolor: black
endnote: no
header-includes:
      - \usepackage{array}
      - \usepackage{caption}
      - \usepackage{graphicx}
      - \usepackage{siunitx}
      - \usepackage{colortbl}
      - \usepackage{multirow}
      - \usepackage{hhline}
      - \usepackage{calc}
      - \usepackage{tabularx}
      - \usepackage{threeparttable}
      - \usepackage{wrapfig}
---

```{r setup, include=FALSE}
options(tinytex.verbose = TRUE)

knitr::opts_chunk$set(cache = TRUE, echo = FALSE, fig.width=6.5, fig.height=2.5, cache.extra = tools::md5sum(here::here("data", "dcpo_input_raw.csv")))

# If `DCPOtools` is not yet installed:
# remotes::install_github("fsolt/DCPOtools")

library(DCPOtools)
library(DCPO)
library(tidyverse)

set.seed(324)
```

We classified the available survey items on gender egalitarian attitudes into four categories.  
The first of these categories consists of questions asking respondents' views on women gaining opportunities in the traditionally masculine public sphere of education, paid work, and politics.
The second category, in turn, encompasses questions focusing on whether and to what degree men should take on responsibilities in the traditionally feminine private sphere of housework and childcare.
A third category we identified comprises questions asking respondents how women should balance opportunities in the public sphere with their traditional duties in the private sphere; it is telling, though not surprising, that the complementary set of questions, on how _men_ should balance responsibilities in the private sphere with their traditional roles in the public sphere, is virtually never included in surveys.
The fourth and final category includes respondents' views on various forms of women's domination by men, from whether wives should adopt their husbands' surnames to the recognition of sexual harassment and the justifiability of intimate partner violence committed by husbands.
To avoid any potential multidimensionality in the Public Gender Egalitarianism index, we include only questions from the first category, gender egalitarianism in the public sphere.
Thus, the "Public" in the name of the index does double duty, referring both to the fact that it measures the _public's_ attitudes on gender equality and to specifically its attitudes on this _public_ aspect of gender egalitarianism.


# The Source Data on Gender Egalitarian Attitudes

```{r dcpo_input_raw, include=FALSE, cache.extra = tools::md5sum(here::here("data-raw", "surveys_egr.csv"))}
surveys_egr <- read_csv(here::here("data-raw", "surveys_egr_classification.csv"),
                        col_types = "ccccnnn")

surveys_egr_public <- surveys_egr %>% 
  filter(agreed == 1)

surveys_egr_private <- surveys_egr %>% 
  filter(agreed == 2)

surveys_egr_balance <- surveys_egr %>% 
  filter(agreed == 3)

surveys_egr_dominance <- surveys_egr %>% 
  filter(agreed == 4)

dcpo_input_raw_public <- DCPOtools::dcpo_setup(vars = surveys_egr_public,
                                               datapath = here::here("..",
                                                                     "data", "dcpo_surveys"),
                                               file = here::here("data",
                                                                 "dcpo_input_raw_public.csv"))

dcpo_input_raw_private <- DCPOtools::dcpo_setup(vars = surveys_egr_private,
                                               datapath = here::here("..",
                                                                     "data", "dcpo_surveys"),
                                               file = here::here("data",
                                                                 "dcpo_input_raw_private.csv"))

dcpo_input_raw_balance <- DCPOtools::dcpo_setup(vars = surveys_egr_balance,
                                               datapath = here::here("..",
                                                                     "data", "dcpo_surveys"),
                                               file = here::here("data",
                                                                 "dcpo_input_raw_balance.csv"))

dcpo_input_raw_dominance <- DCPOtools::dcpo_setup(vars = surveys_egr_dominance,
                                               datapath = here::here("..",
                                                                     "data", "dcpo_surveys"),
                                               file = here::here("data",
                                                                 "dcpo_input_raw_dominance.csv"))
```

```{r egr_summary_stats}
dcpo_input_raw_public <- read_csv(here::here("data", "dcpo_input_raw_public.csv"),
                                  col_types = "cdcddcd")

process_dcpo_input_raw <- function(dcpo_input_raw_df) {
  dcpo_input_raw_df %>% 
  with_min_yrs(2) %>% 
  with_min_cy(5) %>% 
  group_by(country) %>% 
  mutate(cc_rank = n()) %>% 
  ungroup() %>% 
  arrange(-cc_rank)
} 

dcpo_input_raw_public1 <- process_dcpo_input_raw(dcpo_input_raw_public)
dcpo_input_raw_private1 <- process_dcpo_input_raw(dcpo_input_raw_private)
dcpo_input_raw_balance1 <- process_dcpo_input_raw(dcpo_input_raw_balance)
dcpo_input_raw_dominance1 <- process_dcpo_input_raw(dcpo_input_raw_dominance)

n_surveys <- surveys_egr %>%
  distinct(survey) %>% 
  nrow()

n_items <- dcpo_input_raw_public1 %>%
  distinct(item) %>% 
  nrow()

n_countries <- dcpo_input_raw_public1 %>%
  distinct(country) %>% 
  nrow()

n_years <- as.integer(summary(dcpo_input_raw_public1$year)[6]-summary(dcpo_input_raw_public1$year)[1])

total_cy <- {n_countries * n_years} %>% 
  scales::comma()

year_range <- paste("from",
                    summary(dcpo_input_raw_public1$year)[1],
                    "to",
                    summary(dcpo_input_raw_public1$year)[6])

n_cyi <- dcpo_input_raw_public1 %>% 
  distinct(country, year, item) %>% 
  nrow() %>% 
  scales::comma()
```

The first step towards remedying this problem is collecting the available public opinion data on gender egalitarian attitudes.
We draw on data from `r n_surveys` survey datasets, in which we identified `r n_items` distinct relevant survey items that were asked in no fewer than five country-years.
Together, these survey items were asked in `r n_countries` different countries in at least two time points over `r n_years` years, `r year_range`, yielding a total of `r n_cyi` country-year-item observations.
Considering that observations for every year in each country surveyed would number `r total_cy` and so a complete set of country-year-items would encompass `r {n_countries * n_years * n_items} %>% scales::comma()` observations, the available data is clearly very, very sparse.

```{r obs_by_item, fig.height=3, fig.cap = "Items with the Most Observations in the Source Data \\label{items_by_obs}"}
dcpo_input_raw_public1 %>%
  distinct(country, year, item) %>%
  count(item) %>%
  arrange(desc(n)) %>% 
  head(12) %>% 
  ggplot(aes(forcats::fct_reorder(item, n, .desc = TRUE), n)) +
  geom_bar(stat = "identity") +
  theme_bw() +
  theme(axis.title.x = element_blank(),
        axis.text.x  = element_text(angle = 90, vjust = .45, hjust = .95)) +
  ylab("Country-Years Observed")

polileader4_cy <- dcpo_input_raw_public1 %>% filter(item == "polileader4") %>% distinct(country, year) %>% nrow()

polileader4_surveys <- dcpo_input_raw_public1 %>% filter(item == "polileader4") %>% distinct(survey) %>% pull(survey)

housewifefull4_cy <- dcpo_input_raw_public1 %>% filter(item == "housewifefull4") %>% distinct(country, year) %>% nrow()
```

Figure&nbsp;\ref{items_by_obs} displays in how many country-years each of the twelve most-commonly asked items are available.
The `polileader4` item, which asks respondents whether they strongly agree, agree, disagree, or strongly disagree with the statement "On the whole, men make better political leaders than women do," was the most frequently asked question in the data we collected.
Employed by the Americas Barometer, the Arab Barometer, the Eurobarometer, the LatinobarÃ³metro, the Pew Research Center, and the World Values Survey, this question was asked in a total of `r polileader4_cy` different country-years.
That this constitutes only `r round(polileader4_cy*100/(n_countries * n_years))`% of the `r total_cy` total possible country-years covered---and remember, `polileader4` is the _most common_ survey item---again underscores just how sparse the available public opinion data is on this topic.

Which countries are the most data-rich?
Figure&nbsp;\ref{countries_by_obs} below shows the dozen countries with the highest count of country-year-item observations.


```{r obs_by_country, fig.cap = "Countries with the Most Observations in the Source Data \\label{countries_by_obs}"}
dcpo_input_raw_public1 %>%
  mutate(country = if_else(stringr::str_detect(country, "United"),
                           stringr::str_replace(country, "((.).*) ((.).*)", "\\2.\\4."),
                           country)) %>% 
  distinct(country, year, item) %>% 
  count(country) %>%
  arrange(desc(n)) %>% 
  head(12) %>% 
  ggplot(aes(forcats::fct_reorder(country, n, .desc = TRUE), n)) +
  geom_bar(stat = "identity") +
  theme_bw() +
  theme(axis.title.x = element_blank(),
        axis.text.x  = element_text(angle = 90, vjust = .45, hjust = .95)) +
  ylab("Year-Items Observed")

# uk_nas <- {1 + max(swiid_source$year) - min(swiid_source$year) - 
# {swiid_source %>% filter(country == "United Kingdom") %>% pull(year) %>% unique() %>% length()}} %>%
# wordify_numeral()
# 
# iran_obs <- swiid_source %>% filter(country == "Iran") %>% pull(year) %>% unique() %>% length()
# 
# med_cy <- swiid_source %>% count(country, year) %>% count(country, name = "nn") %>% pull(nn) %>% median() %>% wordify_numeral()
```

```{r years_by_country, fig.cap="Country-Year Coverage in the Source Data \\label{countries_by_years}"}
library(patchwork)

cby_plot <- dcpo_input_raw_public1 %>%
  mutate(country = if_else(stringr::str_detect(country, "United"),
                           stringr::str_replace(country, "((.).*) ((.).*)", "\\2.\\4."),
                           country),
         country = stringr::str_replace(country, "South", "S.")) %>% 
  distinct(country, year) %>%
  count(country) %>% 
  arrange(desc(n)) %>% 
  head(12) %>% 
  ggplot(aes(forcats::fct_reorder(country, n, .desc = TRUE), n)) +
  geom_bar(stat = "identity") +
  theme_bw() +
  theme(axis.title.x = element_blank(),
        axis.text.x  = element_text(angle = 90, vjust = .45, hjust = .95)) +
  ylab("Years Observed")


ybc_plot <- dcpo_input_raw_public1 %>%
  distinct(country, year) %>%
  count(year, name = "nn") %>%
  ggplot(aes(year, nn)) +
  geom_bar(stat = "identity") +
  theme_bw() +
  theme(axis.title.x = element_blank(),
        axis.text.x  = element_text(angle = 90, vjust = .45, hjust = .95)) +
  ylab("Countries Observed")

cby_plot + ybc_plot
```


```{r dcpo_input_public}
dcpo_input_public <- DCPOtools::format_dcpo(dcpo_input_raw_public1,
                                            scale_q = "polileader4",
                                            scale_cp = 2)
save(dcpo_input_public, file = here::here("data", "dcpo_input_public.rda"))
```

# Estimating Public Gender Egalitarianism

The DCPO model is estimated using the `DCPO` package for R [@Solt2020a], which is written in the Stan probabilistic programming language [@StanDevTeam2019a; @StanDevTeam2019b].

```{r dcpo, eval=FALSE}
iter <- 4000

dcpo_output <- dcpo(dcpo_input,
                    iter = iter,
                    chains = 4,
                    thin = iter/500, # this yields 250 draws per chain, 1000 draws total
                    pars = c("sd_delta","sd_theta_evolve", "sd_sigma_evolve", "sigma","phi","beta","alpha","delta","theta","y_r_pred","log_lik"))

save(dcpo_output, file = here::here("data", "dcpo_output.rda"))

dcpo_theta <- rstan::extract(dcpo_output, pars = "theta")

save(dcpo_theta, file = here::here("data", "dcpo_theta.rda"))

dcpo_sigma <- rstan::extract(dcpo_output, pars = "sigma")

save(dcpo_theta, file = here::here("data", "dcpo_sigma.rda"))

dcpo_y_r_pred <- rstan::extract(dcpo_output, pars = "y_r_pred")

save(dcpo_input, dcpo_y_r_pred, file = here::here("data", "dcpo_y_r_pred.rda"))
```

```{r cs_plot, fig.cap="Egalitarian Gender Attitudes, 2020 \\label{cs_2020}", fig.height=8, warning=FALSE}
load(here::here("data", "dcpo_input.rda"))
load(here::here("data", "dcpo_output.rda"))

theta_results <- DCPO::summarize_dcpo_results(dcpo_input,
                                              dcpo_output,
                                              "theta")

sigma_results <- DCPO::summarize_dcpo_results(dcpo_input,
                                              dcpo_output,
                                              "sigma")

p1_data <- theta_results %>%
    group_by(country) %>%
    top_n(1, year) %>%
    ungroup() %>%
    arrange(-mean) %>%
    mutate(half = ntile(mean, 2))

p1_data_a <- p1_data %>% filter(half==2) %>% mutate(ranked = as.factor(row_number(mean)))
p1_data_b <- p1_data %>% filter(half==1) %>% mutate(ranked = as.factor(row_number(mean)))

p1a <- ggplot(p1_data_a, aes(x = mean,
                             y = ranked)) +
    geom_segment(aes(x = `10%`, xend = `90%`,
                     y = ranked, yend = as.factor(ranked)),
                 na.rm = TRUE) +
    geom_point(fill = "black", shape = 21, size = 1.1, na.rm = TRUE) +
    theme_bw() + theme(legend.position="none",
                       axis.text.x  = element_text(size=8),
                       axis.text.y  = element_text(size=8),
                       axis.title.x = element_text(face="bold", size=8),
                       legend.text = element_text(size = 7),
                       legend.title = element_text(size=7, face = "bold"),
                       legend.key.size = unit(.5, "line"),
                       legend.background = element_rect(linetype = "solid",
                                                        color = "grey80",
                                                        size = .25),
                       legend.key = element_rect(colour = "white")) +
    scale_y_discrete(breaks = p1_data_a$ranked, labels=p1_data_a$country) +
    coord_cartesian(xlim=c(0, 1)) +
    labs(x = NULL, y = NULL)

p1b <- ggplot(p1_data_b, aes(x = mean,
                             y = ranked)) +
    geom_segment(aes(x = `10%`, xend = `90%`,
                     y = ranked, yend = ranked),
                 na.rm = TRUE) +
    geom_point(fill = "black", shape = 21, size = 1.1, na.rm = TRUE) +
    theme_bw() + theme(legend.position="none",
                       axis.text.x  = element_text(size=8),
                       axis.text.y  = element_text(size=8),
                       axis.title.x = element_text(face="bold", size=8)) +
    scale_y_discrete(breaks = p1_data_b$ranked, labels=p1_data_b$country) +
    coord_cartesian(xlim=c(0, 1)) +
    labs(x = NULL, y = NULL)

p1a + p1b

```

# Validating Public Gender Egalitarianism

# Using the Public Gender Egalitarianism Index

One aspect of latent-variable estimates of public opinion like the PGE that is easy for researchers to overlook is the uncertainty in the estimates.
But neglecting to incorporate this uncertainty by using only the mean estimate for each country-year in an analysis can lead one to mistakenly conclude that the analysis supports the hypothesis [see @Tai2020] as well as to mistakenly conclude that it does _not_ support the hypothesis [see @Crabtree2015].
Therefore, taking the uncertainty in the PGE index into account is crucial to reaching well-grounded conclusions.

The PGE download includes pre-formatted data to facilitate incorporating the uncertainty in the index.
In R, the functions of the \texttt{purrr} package [@Henry2019, also included in the widely-used \texttt{tidyverse} package [@Wickham2017a]] make it entirely straightforward to incorporate the uncertainty of the PGE estimates.
In Stata, the \texttt{mi estimate:} command prefix originally developed for analyzing multiply imputed data can be used to automate the process of building uncertainty into nearly any analysis.
Step-by-step instructions on how to use these tools, complete with examples, are included in the data download.

# Conclusion

\pagebreak
