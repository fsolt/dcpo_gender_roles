---
title: 'Appendix to Public Gender Egalitarianism: A Dataset of Dynamic Comparative
  Public Opinion Toward Egalitarian Gender Roles in the Public Sphere'
author: ""
date: "`r format(Sys.time(), '%B %d, %Y')`"
bibliography: dcpo_gender_roles.bib
biblio-style: apsr
linestretch: 1.1
output: 
    pdf_document:
        toc: true
header-includes:
      - \usepackage{float}
      - \usepackage{array}
      - \usepackage{caption}
      - \usepackage{graphicx}
      - \usepackage{siunitx}
      - \usepackage{colortbl}
      - \usepackage{multirow}
      - \usepackage{hhline}
      - \usepackage{calc}
      - \usepackage{tabularx}
      - \usepackage{threeparttable}
      - \usepackage{wrapfig}
      - \usepackage{booktabs}
---

\renewcommand{\thepage}{A\arabic{page}}
\setcounter{figure}{0}
\renewcommand{\thefigure}{A\arabic{figure}}
\setcounter{table}{0}
\renewcommand{\thetable}{A\arabic{table}}

```{r setup, include=FALSE}
options(tinytex.verbose = TRUE)

knitr::opts_chunk$set(cache = FALSE, echo = FALSE, message = FALSE, warning = FALSE)

# If `DCPOtools` is not yet installed:
# remotes::install_github("fsolt/DCPOtools")

# If development version of `DCPO` is not yet installed:
# remotes::install_github("fsolt/DCPO")

library(DCPOtools)
library(DCPO)
library(tidyverse)
library(glue)
library(countrycode)
library(patchwork)
library(modelsummary)

set.seed(324)
```

\pagebreak
# Appendix A: Survey Items Used to Estimate Public Gender Egalitarianism and Their Distribution
```{r egr_summary_stats, cache = FALSE, cache.extra = tools::md5sum(here::here("data-raw", "dcpo_input_raw_public.csv"))}
dcpo_input_raw_public <- read_csv(here::here("data", "dcpo_input_raw_public.csv"),
                                  col_types = "cdcddcd")

public_items <- read_csv(here::here("data-raw", "public_items.csv"),
                         col_types = "ccddd")

process_dcpo_input_raw <- function(dcpo_input_raw_df) {
  dcpo_input_raw_df %>% 
    with_min_yrs(2) %>% 
    with_min_cy(5) %>% 
    filter(year >= 1972) %>% 
    group_by(country) %>% 
    mutate(cc_rank = n()) %>% 
    ungroup() %>% 
    arrange(-cc_rank)
} 

dcpo_input_raw_public1 <- process_dcpo_input_raw(dcpo_input_raw_public) %>% 
  left_join(public_items, by = "item")
dcpo_input_raw_poliwork1 <- dcpo_input_raw_public1 %>% 
  filter(political==1|workplace==1)

surveys_egr <- read_csv(here::here("data-raw", "surveys_egr_classification.csv"),
                        col_types = "ccccnnn")

n_surveys <- surveys_egr %>% 
  filter(agreed == 1) %>%
  distinct(survey) %>% 
  nrow()

n_items <- dcpo_input_raw_poliwork1 %>%
  distinct(item) %>% 
  nrow()

n_countries <- dcpo_input_raw_poliwork1 %>%
  distinct(country) %>% 
  nrow()

n_cy <- dcpo_input_raw_poliwork1 %>%
  distinct(country, year) %>% 
  nrow() %>% 
  scales::comma()

n_years <- as.integer(summary(dcpo_input_raw_poliwork1$year)[6]-summary(dcpo_input_raw_poliwork1$year)[1])

spanned_cy <- dcpo_input_raw_poliwork1 %>% 
  group_by(country) %>% 
  summarize(years = max(year) - min(year) + 1) %>% 
  summarize(n = sum(years)) %>% 
  pull(n) %>% 
  scales::comma()

total_cy <- {n_countries * n_years} %>% 
  scales::comma()

year_range <- paste("from",
                    summary(dcpo_input_raw_poliwork1$year)[1],
                    "to",
                    summary(dcpo_input_raw_poliwork1$year)[6])

n_cyi <- dcpo_input_raw_poliwork1 %>% 
  distinct(country, year, item) %>% 
  nrow() %>% 
  scales::comma()

back_to_numeric <- function(string_number) {
  string_number %>% 
    str_replace(",", "") %>% 
    as.numeric()
}
```
National and cross-national surveys have often included questions tapping attitudes toward equality for women and men in the public sphere over the past half-century, but the resulting data are both sparse, that is, unavailable for many countries and years, and incomparable, generated by many different survey items.
In all, we identified `r n_items` such survey items that were asked in no fewer than five country-years in countries surveyed at least twice; these items were drawn from `r n_surveys` different survey datasets.
These items are listed in the table below, along with the dispersion ($\alpha$) and difficulty ($\beta$) scores estimated for each from the DCPO model.
Question text may vary slightly across survey datasets, but not, roughly speaking, by more than the translation differences across languages found within the typical cross-national survey dataset.
Lower values of dispersion indicate questions that better identify publics with more public gender egalitarianism from those with less.
Items have one less difficulty score than the number of response categories.
Survey dataset codes correspond to those used in the `DCPOtools` R package; they appear in decreasing order of country-years contributed.

Together, the survey items in the source data were asked in `r n_countries` different countries in at least two time points over `r n_years` years, `r year_range`, yielding a total of `r n_cyi` country-year-item observations.
The number of items observed in the source data for each country-year is plotted in Figure \ref{obs_by_cy} below.
The PGE scores of country-years with more observed items are likely to be estimated more precisely.
The estimates for country-years with fewer (or no) observed items rely more heavily (or entirely) on the random-walk prior and are therefore less certain.

Overlap among items have not been a concern in the literature on generating latent-variable estimates of public opinion across countries and over time from sparse data, largely because the dynamic aspect of the models employed, that is, the random-walk prior, works to tie together items that do not overlap [see @Claassen2019; @Caughey2019; @Solt2020c]. 
Nevertheless, the most commonly observed item in the PGE source data, `polileader4`, effectively serves as the bridge between the other items: it has overlapping country-year observations with 39 of the other 50 items (which together cover 91% of the observed country-years), and only a single item (`politics4a`, which covers 22 country-years) had no observations within a year of a `polileader4` observation.


```{r pge_items, cache=TRUE}
load(here::here("data", "dcpo_input.rda"))
load(here::here("data", "dcpo_output.rda"))

pge_items <- read_csv(here::here("data-raw", "egr_questions.csv"),
                      col_types = "cccccc")

alpha_results <- DCPO::summarize_dcpo_results(dcpo_input,
                                              dcpo_output,
                                              "alpha") %>% 
    transmute(item = question,
              dispersion = mean)

beta_results <- DCPO::summarize_dcpo_results(dcpo_input,
                                              dcpo_output,
                                              "beta") %>% 
    group_by(question) %>% 
    summarize(difficulties0 = paste0(sprintf("%.2f", round(mean, 2)),
                                     collapse = ", ")) %>% 
    mutate(item = question,
           cp = as.numeric(str_extract(item, "\\d")) - 1,
           term = str_glue("(( ?-?[0-9].[0-9][0-9]?,?){{{cp}}})"),
           difficulties = str_extract(difficulties0, 
                                      term) %>%
               str_replace(",$", "") %>% 
               str_trim()) %>% 
    transmute(item, difficulties)
                                    
items_summary <- dcpo_input_raw_poliwork1 %>%
  dplyr::select(country, year, item, survey) %>%
  distinct() %>%
  separate(survey, c("surv1", "surv2", "surv3"), sep=", ", fill = "left") %>%
  pivot_longer(cols = starts_with("surv"), values_to = "survey") %>%
  filter(!is.na(survey)) %>% 
  group_by(item) %>% 
  mutate(all_surveys = paste0(unique(survey), collapse = ", ")) %>% 
  ungroup() %>% 
  distinct(country, year, item, .keep_all = TRUE) %>% 
  group_by(item) %>% 
  mutate(n_cy = n()) %>% 
  ungroup() %>%
  distinct(item, n_cy, all_surveys) %>% 
  left_join(public_items %>% select(item, question_text),
            by = "item") %>% 
  left_join(alpha_results, by = "item") %>% 
  left_join(beta_results, by = "item") %>% 
  arrange(-n_cy)
```

```{r pge_items_table1}  
pge_items_table <- function(x) {
  items_summary %>% 
    slice(x) %>% 
    transmute(`Survey\nItem\nCode` = item,
              `Country-Years` = as.character(n_cy),
              `Question Text` = str_replace(question_text, "([^(]*)\\(.*", "\\1"),
              `Dispersion` = dispersion,
              `Difficulties`= difficulties,
              `Survey Dataset Codes` = all_surveys) %>% 
    modelsummary::datasummary_df(output = "kableExtra",
                                 note = "") %>% 
    kableExtra::column_spec(2, width = "4em") %>%     
    kableExtra::column_spec(c(3, 6), width = "11em") %>% 
    kableExtra::column_spec(5, width = "5em")
}

pge_items_table(1:2) %>%
  kableExtra::kable_styling(latex_options = "HOLD_position")
```

```{r pge_items_table2}    
pge_items_table(3:10)
```

```{r pge_items_table3}    
pge_items_table(11:15)
```

```{r pge_items_table4}    
pge_items_table(16:24)
```

```{r pge_items_table5}    
pge_items_table(25:32)
```

```{r pge_items_table6}    
pge_items_table(33:39)
```

```{r pge_items_table7}    
pge_items_table(40:51) %>%
  kableExtra::kable_styling(latex_options = "HOLD_position")
```

```{r obs_by_cy, fig.height = 9, fig.width = 6.5, fig.cap = "Source Data Observations by Country and Year \\label{obs_by_cy}"}
dcpo_input_raw_poliwork1 %>% 
  mutate(country = str_replace(country, "’", "'")) %>% 
  distinct(country, year, item, cc_rank) %>% 
  group_by(country, year) %>% 
  summarize(n = n(),
            cc_rank = cc_rank) %>% 
  ungroup() %>% 
  distinct() %>% 
  ggplot(aes(x = year, 
             y = forcats::fct_reorder(country, cc_rank),
             fill = n)) + 
  geom_tile() +
  scale_fill_stepsn(colors = rev(hcl.colors(6, "inferno")),
                    n.breaks = 6,
                    show.limits = TRUE,
                    right = FALSE,
                    name = "Observations") +
  labs(x = NULL, y = NULL) +
  scale_x_continuous(breaks=seq(1972, 2020, 4),
                     sec.axis = dup_axis()) +
  scale_y_discrete(position = "right") +
  theme(legend.justification=c(0, 0), 
        legend.position=c(0.01, 0.01),
        axis.text.y  = element_text(size = 7)) 
```


\pagebreak
# Appendix B: Excluded Survey Items
To estimate the Public Gender Egalitarianism scores, we collected survey data on questions asking respondents' views of gender equality in the traditionally masculine public sphere of paid work and politics.
These included questions are nearly always explicit in comparing men and women (but see, for example, `unequalpol4`, which asked responses to the statement "Women do not have the necessary qualities and skills to fill positions of responsibility in politics") and nearly always explicitly invoke either paid work or politics, though they may also be broader (see, for example, `equalright2`, which asked "On a different subject, do you think women should have equal rights with men, or shouldn’t they?").

We carefully distinguished these questions from three other categories of questions on gender equality.
First, the PGE source data do not include the small set of questions focusing on gender equality in the traditionally feminine private sphere of housework and childcare, such as "Men should take as much responsibility as women for the home and children," asked (with differing response categories) in the European Values Survey and the European Social Survey.
Second, as noted in the text, we also excluded questions asking respondents how women should balance opportunities in the public sphere with their traditional duties in the private sphere, such as whether mothers in the workforce can have similarly warm relationships with their children as mothers who are not, asked in the World Values Survey and many others.
Given that attitudes that women should prioritize housework and childcare over paid employment and politics---or convictions that there will be negative consequences if they do not---can be expected to lead to less gender egalitarian opinions with regard to these latter, public-sphere activities, this is clearly a very closely related set of items to those we sought, and there are many of them.^[
It is telling, though not surprising, that the complementary set of questions, on how _men_ should balance responsibilities in the private sphere with their traditional roles in the public sphere, is only rarely included in surveys; one laudable example of this mostly unasked sort of question, apparently first included in Australia's 1989 National Social Science Survey and slowly becoming more common, is the item querying respondents the extent to which they agree with the statement, "Family life often suffers when men concentrate too much on their work."]
The third and final category of excluded survey items includes respondents' views on various forms of women's domination by men, from whether wives should always adopt their husbands' surnames through the recognition that various forms of sexual harassment are not "flattering" to the justifiability of intimate partner violence committed by husbands.
In each case, as the included questions are not _directly_ relevant to gender egalitarianism in the public sphere, we concluded that to ensure that the PGE scores tap only a single dimension of attitudes, we would exclude these others (see also Appendix D).
Usefully, this decision also allows, when the available survey data permits, future research to take up the estimation of dynamic comparative public opinion of those concepts separately and their relationships to public gender egalitarianism.

\pagebreak
# Appendix C: The DCPO Model

There has been a recent blossoming of scholarship developing latent variable models of public opinion based on cross-national survey data [see @Claassen2019; @Caughey2019; @McGann2019; @Kolczynska2020].
To estimate public gender egalitarianism across countries and over time, we draw on the latest of these methods that is appropriate for data that is not only incomparable but also sparse, the Dynamic Comparative Public Opinion (DCPO) model presented in @Solt2020c.^[
@Solt2020c demonstrates that the DCPO model provides a better fit to survey data than the models put forward by @Claassen2019 or @Caughey2019.
The @McGann2019 model depends on dense survey data unlike the sparse data on public gender egalitarianism described in the preceding section.
@Kolczynska2020 is the very most recent of the five works and builds on each of the others, but the MRP approach developed in that piece is suitable not only when the available survey data are dense but also when ancillary data on population characteristics are available, so it is similarly inappropriate to this application.]
The DCPO model is a population-level two-parameter ordinal logistic item response theory (IRT) model with country-specific item-bias terms.

DCPO models the total number of survey responses expressing at least as much public gender egalitarianism as response category $r$ to each question $q$ in country $k$ at time $t$, $y_{ktqr}$, out of the total number of respondents surveyed, $n_{ktqr}$, using the beta-binomial distribution:

\begin{equation}
a_{ktqr} = \phi\eta_{ktqr} \label{eq:bb_a}
\end{equation}
\begin{equation}
b_{ktqr} = \phi(1 - \eta_{ktqr}) \label{eq:bb_b}
\end{equation}
\begin{equation}
y_{ktqr} \sim \textrm{BetaBinomial}(n_{ktqr}, a_{ktqr}, b_{ktqr}) \label{eq:betabinomial}
\end{equation}

where $\phi$ represents an overall dispersion parameter to account for additional sources of survey error beyond sampling error and $\eta_{ktqr}$ is the expected probability that a random person in country $k$ at time $t$ answers question $q$ with a response at least as positive as response $r$.^[
The ordinal responses to question $q$ are coded to range from 1 (expressing the least public gender egalitarianism) to $R$ (expressing the most public gender egalitarianism), and $r$ takes on all values greater than 1 and less than or equal to $R$.]

This expected probability, $\eta_{ktqr}$, is in turn estimated as follows:

\begin{equation}
\eta_{ktqr} = \textrm{logit}^{-1}(\frac{\bar{\theta'}_{kt} - (\beta_{qr} + \delta_{kq})}{\sqrt{\alpha_{q}^2 + (1.7*\sigma_{kt})^2}}) \label{eq:dcpo}
\end{equation}

In this equation, $\beta_{qr}$ represents the difficulty of response $r$ to question $q$, that is, the degree of public gender egalitarianism the response expresses.  The $\delta_{kq}$ term represents country-specific item bias: the extent to which all responses to a particular question $q$ may be more (or less) difficult in a given country $k$ due to translation issues, cultural differences in response styles, or other idiosyncrasies that render the same survey item not equivalent across countries.^[
Estimating $\delta_{kq}$ requires repeated administrations of question $q$ in country $k$, so
when responses to question $q$ are observed in country $k$ in only a single year, the DCPO model sets $\delta_{kq}$ to zero by assumption, increasing the error of the model by any country-item bias that is present.
Questions that are asked repeatedly over time in only a single country pose no risk of country-specific item bias, so $\delta_{kq}$ in such cases are also set to zero.]
The dispersion of question $q$, its noisiness in relation to our latent variable, is $\alpha_{q}$. The mean and standard deviation of the unbounded latent trait of public gender egalitarianism are $\bar{\theta'}_{kt}$ and $\sigma_{kt}$, respectively.

Random-walk priors are used to account for the dynamics in $\bar{\theta'}_{kt}$ and $\sigma_{kt}$, and weakly informative priors are placed on the other parameters.^[
The dispersion parameters $\alpha_{q}$ are drawn from standard half-normal prior distributions, that is, the positive half of N(0, 1).
The first difficulty parameters for each question, $\beta_{q1}$, are drawn from standard normal prior distributions, and the differences between $\beta$s for each $r$ for the same question $q$ are drawn from standard half-normal prior distributions.
The item-bias parameters $\delta_{kq}$ receive normally-distributed hierarchical priors with mean 0 and standard deviations drawn from standard half-normal prior distributions.
The initial value of the mean unbounded latent trait for each country, $\bar{\theta'}_{k1}$, is assigned a standard normal prior, as are the transition variances $\sigma_{\bar{\theta'}}^2$ and $\sigma_{\sigma}^2$; the initial value of the standard deviation of the unbounded latent trait for each country, $\sigma_{k1}$, is drawn from a standard lognormal prior distribution.
The overall dispersion, $\phi$, receives a somewhat more informative prior drawn from a gamma(4, 0.1) distribution that yields values that are well scaled for that parameter.]
The dispersion parameters $\alpha_q$ are constrained to be positive and all survey responses are coded with high values indicating more public gender egalitarianism to fix direction.
The difficulty $\beta$ of "disagree" (on the four-point, "strongly agree" to "strongly disagree" scale) to the statement "On the whole, men make better political leaders than women do" is set to 1 to identify location, and for each question $q$ the difficulties for increasing response categories $r$ are constrained to be increasing.
The sum of $\delta_{kq}$ across all countries $k$ is set to zero for each question $q$:

\begin{equation}
\sum_{k = 1}^K \delta_{kq} = 0
\end{equation}

Finally, the logistic function is used to transform $\bar{\theta'}_{kt}$ to the unit interval and so give the bounded mean of latent public gender egalitarianism, $\bar{\theta}_{kt}$, which is our parameter of interest here [see @Solt2020c, 3-8].



\pagebreak
# Appendix D: Confirming the Unidimensionality of Public Gender Egalitarianism

To provide further confirmation of the unidimensionality of public gender egalitarianism, we used the survey items listed in Appendix A to estimate separate indices of gender egalitarianism in politics and in the workplace.  As shown in Figure \ref{pge_pwe_corr_plot}, these two indices both correlate very highly with the PGE scores and with each other, reinforcing the conclusion that public gender egalitarianism exists as a single dimension across countries and years.

```{r create_pwe_indices, cache=TRUE}
dcpo_input_raw_public <- read_csv(here::here("data", "dcpo_input_raw_public.csv"),
                                  col_types = "cdcddcd")
public_items <- read_csv(here::here("data-raw", "public_items.csv"),
                         col_types = "ccddd")

process_dcpo_input_raw <- function(dcpo_input_raw_df) {
  dcpo_input_raw_df %>% 
  with_min_yrs(2) %>% 
  with_min_cy(5) %>% 
  group_by(country) %>% 
  mutate(cc_rank = n()) %>% 
  ungroup() %>% 
  arrange(-cc_rank)
}

dcpo_input_raw_public1 <- process_dcpo_input_raw(dcpo_input_raw_public) %>% 
  left_join(public_items, by = "item")
dcpo_input_raw_political1 <- dcpo_input_raw_public1 %>% 
  filter(political==1)
dcpo_input_raw_workplace1 <- dcpo_input_raw_public1 %>% 
  filter(workplace==1)

dcpo_input_political <- DCPOtools::format_dcpo(dcpo_input_raw_political1,
                                            scale_q = "polileader4",
                                            scale_cp = 2)
save(dcpo_input_political, file = here::here("data", "dcpo_input_political.rda"))

dcpo_input_workplace <- DCPOtools::format_dcpo(dcpo_input_raw_workplace1,
                                            scale_q = "job3a",
                                            scale_cp = 2)
save(dcpo_input_workplace, file = here::here("data", "dcpo_input_workplace.rda"))

```

```{r dcpo_political, eval=FALSE}
iter <- 4000

dcpo_output_political <- dcpo(dcpo_input_political,
                              iter = iter,
                              chains = 4,
                              thin = iter/500, # this yields 250 draws per chain, 1000 draws total
                              pars = c("sd_delta","sd_theta_evolve", "sd_sigma_evolve", "sigma","phi","beta","alpha","delta","theta","y_r_pred","log_lik"))
```

```{r dcpo_workplace, eval=FALSE}
iter <- 5000

dcpo_output_workplace <- dcpo(dcpo_input_workplace,
                              iter = iter,
                              chains = 4,
                              thin = iter/500, # this yields 250 draws per chain, 1000 draws total
                              pars = c("sd_delta","sd_theta_evolve", "sd_sigma_evolve", "sigma","phi","beta","alpha","delta","theta","y_r_pred","log_lik"))
```

```{r political, eval=FALSE}
load(here::here("data", "political_polileader4_2_4k.rda"))

dcpo_input_political <- dcpo_input

dcpo_output_political <- dcpo_output

save(dcpo_input_political, file = here::here("data", "dcpo_input_political.rda"))

save(dcpo_output_political, file = here::here("data", "dcpo_output_political.rda"))
```

```{r workplace, eval=FALSE}
load(here::here("data", "workplace_job3a_2_5k.rda"))

dcpo_input_workplace <- dcpo_input

dcpo_output_workplace <- dcpo_output

save(dcpo_input_workplace, file = here::here("data", "dcpo_input_workplace.rda"))

save(dcpo_output_workplace, file = here::here("data", "dcpo_output_workplace.rda"))
```

```{r theta_res_political, cache=TRUE}
load(here::here("data", "dcpo_input_political.rda"))
load(here::here("data", "dcpo_output_political.rda"))

dat <- dcpo_input_political$data

qcodes <- dat %>%
  dplyr::group_by(question) %>%
  dplyr::summarize(qq = first(qq) %>%
                     as.numeric())

kcodes <- dat %>%
  dplyr::group_by(country) %>%
  dplyr::summarize(kk = first(kk) %>%
                     as.numeric())

tcodes <- dat %>%
  dplyr::group_by(year) %>%
  dplyr::summarize(tt = first(tt))

ktcodes <- dat %>%
  dplyr::group_by(country) %>%
  dplyr::summarize(first_yr = min(year),
                   last_yr = max(year))

theta_res_political <- rstan::extract(dcpo_output_political, pars = "theta") %>%
        dplyr::first() %>%
        purrr::array_branch(1) %>%
        purrr::map(function(x) {
          tibble::as_tibble(x) %>%
          dplyr::mutate(tt = dplyr::row_number()) %>%
            dplyr::left_join(tcodes, by = "tt") %>%
            tidyr::pivot_longer(cols = starts_with("V"),
                                names_to = "kk",
                                values_to = "pge_mean") %>%
            dplyr::mutate(year = if_else(tt == 1,
                                         as.integer(year),
                                         as.integer(min(year, na.rm = TRUE) + tt - 1)),
                          kk = stringr::str_replace(kk, "V", "") %>% as.numeric()) %>%
            dplyr::left_join(kcodes, by = "kk") %>%
            dplyr::left_join(ktcodes, by = "country") %>%
            dplyr::filter(year >= first_yr & year <= last_yr) %>%
            dplyr::arrange(kk, tt) %>%
            dplyr::select(country, year, pge_mean) %>% 
            dplyr::rename(political_mean = pge_mean)
        })
```

```{r theta_res_workplace, cache=TRUE}
load(here::here("data", "dcpo_input_workplace.rda"))
load(here::here("data", "dcpo_output_workplace.rda"))

dat <- dcpo_input_workplace$data

qcodes <- dat %>%
  dplyr::group_by(question) %>%
  dplyr::summarize(qq = first(qq) %>%
                     as.numeric())

kcodes <- dat %>%
  dplyr::group_by(country) %>%
  dplyr::summarize(kk = first(kk) %>%
                     as.numeric())

tcodes <- dat %>%
  dplyr::group_by(year) %>%
  dplyr::summarize(tt = first(tt))

ktcodes <- dat %>%
  dplyr::group_by(country) %>%
  dplyr::summarize(first_yr = min(year),
                   last_yr = max(year))

theta_res_workplace <- rstan::extract(dcpo_output_workplace, pars = "theta") %>%
        dplyr::first() %>%
        purrr::array_branch(1) %>%
        purrr::map(function(x) {
          tibble::as_tibble(x) %>%
          dplyr::mutate(tt = dplyr::row_number()) %>%
            dplyr::left_join(tcodes, by = "tt") %>%
            tidyr::pivot_longer(cols = starts_with("V"),
                                names_to = "kk",
                                values_to = "pge_mean") %>%
            dplyr::mutate(year = if_else(tt == 1,
                                         as.integer(year),
                                         as.integer(min(year, na.rm = TRUE) + tt - 1)),
                          kk = stringr::str_replace(kk, "V", "") %>% as.numeric()) %>%
            dplyr::left_join(kcodes, by = "kk") %>%
            dplyr::left_join(ktcodes, by = "country") %>%
            dplyr::filter(year >= first_yr & year <= last_yr) %>%
            dplyr::arrange(kk, tt) %>%
            dplyr::select(country, year, pge_mean) %>% 
            dplyr::rename(workplace_mean = pge_mean)
        })
```

```{r pge_pwe_corr, cache=TRUE}
load(here::here("data", "pge.rda"))
load(here::here("data", "dcpo_input.rda"))

pge_pw <- map(1:1000, function(x) {
  pge[[x]] %>% 
    left_join(theta_res_political[[x]], by = c("country", "year")) %>% 
    left_join(theta_res_workplace[[x]], by = c("country", "year"))
})

pge_political_cor <- map(pge_pw, function(x) {
  with(x, cor(pge_mean, political_mean, use = "pairwise.complete.obs"))
  }) %>% 
  unlist() %>% 
  mean() %>% 
  round(2)

pge_workplace_cor <- map(pge_pw, function(x) {
  with(x, cor(pge_mean, workplace_mean, use = "pairwise.complete.obs"))
  }) %>% 
  unlist() %>% 
  mean() %>% 
  round(2)

political_workplace_cor <- map(pge_pw, function(x) {
  with(x, cor(political_mean, workplace_mean, use = "pairwise.complete.obs"))
  }) %>% 
  unlist() %>% 
  mean() %>% 
  round(2)

pge_pwe_corr_matrix <- matrix(c(1, pge_political_cor, pge_workplace_cor,
                                pge_political_cor, 1, political_workplace_cor,
                                pge_workplace_cor, political_workplace_cor, 1),
                              ncol = 3)
colnames(pge_pwe_corr_matrix) <- c("Public\nGender\nEgalitarianism", "Political\nGender\nEgalitarianism", "Workplace\nGender\nEgalitarianism")
```

```{r pge_pwe_corr_plot, fig.width=7, fig.cap = "Pairwise Correlations Among PGE Index and Separate Political and Workplace Egalitarianism Indices  \\label{pge_pwe_corr_plot}"}
corrplot::corrplot.mixed(pge_pwe_corr_matrix, tl.col = "black", tl.cex = .8, upper = "ellipse")
```

\pagebreak
# References  {-}

